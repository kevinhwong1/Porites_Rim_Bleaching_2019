---
title: "Metabolomics WGCNA"
author: "Author: Kevin Wong; kevinhwong1@gmail.com"
output:
  github_document: default
  pdf_document:
    keep_tex: yes
  html_document:
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Pipeline Overview

1. Data preparation
  + Load and format clean data
  + Data filtering: PoverA and genefilter
  + Outlier detection
2. Network construction and consensus modlue detection
  + Choosing a soft-thresholding power: Analysis of a network topology β
  + Co-expression adjacency and topological overlap matrix similarity
  + Clustering using TOM
  + Module idenification using dynamicTreeCut
3. Correlate groups/timepoints
4. Plot module-trait associations
5. Plot eigennene over groupings
6. Calculating gene significance and module membership

This pipeline is modified from AH: 
* https://github.com/AHuffmyer/EarlyLifeHistory_Energetics/blob/master/Mcap2020/Scripts/Metabolomics/metabolomics_WGCNA.Rmd

Initial thoughts: 

* First I will run this with 9 different groupings (3x3 design). Not sure if this is correct, but it will give us an overall idea
* Second I will run this with 3 times for each time point, or 3 time for each grouping
* Third I will think about how to use the WGCNA to correlate other datasets (i.e. phys or tag-seq modules)


```{r dependencies, warning=FALSE, message=FALSE}

## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("vegan" %in% rownames(installed.packages()) == 'FALSE') install.packages('vegan') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("factoextra" %in% rownames(installed.packages()) == 'FALSE') install.packages('factoextra') 
if ("ggfortify" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggfortify') 
if ("naniar" %in% rownames(installed.packages()) == 'FALSE') install.packages('naniar') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
if ("mixOmics" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install("mixOmics") 
if ("RVAideMemoire" %in% rownames(installed.packages()) == 'FALSE') install.packages('RVAideMemoire') 
if ("VennDiagram" %in% rownames(installed.packages()) == 'FALSE') install.packages('VennDiagram') 
if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom') 

#load packages
library("ggplot2")
library('vegan')
library('factoextra')
library('ggfortify')
library('naniar')
library('cowplot')
library("mixOmics")
library("tidyverse")
library("RVAideMemoire")
library("VennDiagram")
library("broom")

if ("genefilter" %in% rownames(installed.packages()) == 'FALSE') install.packages('genefilter') 
if ("DESeq2" %in% rownames(installed.packages()) == 'FALSE') install.packages('DESeq2') 
if ("RColorBrewer" %in% rownames(installed.packages()) == 'FALSE') install.packages('RColorBrewer') 
if ("WGCNA" %in% rownames(installed.packages()) == 'FALSE') install.packages('WGCNA') 
if ("flashClust" %in% rownames(installed.packages()) == 'FALSE') install.packages('flashClust') 
if ("gridExtra" %in% rownames(installed.packages()) == 'FALSE') install.packages('gridExtra') 
if ("ComplexHeatmap" %in% rownames(installed.packages()) == 'FALSE') install.packages('ComplexHeatmap') 
if ("goseq" %in% rownames(installed.packages()) == 'FALSE') install.packages('goseq') 
if ("dplyr" %in% rownames(installed.packages()) == 'FALSE') install.packages('dplyr') 
if ("clusterProfiler" %in% rownames(installed.packages()) == 'FALSE') install.packages('clusterProfiler') 
if ("pheatmap" %in% rownames(installed.packages()) == 'FALSE') install.packages('pheatmap') 
if ("magrittr" %in% rownames(installed.packages()) == 'FALSE') install.packages('magrittr') 

library("genefilter")
library("DESeq2")
library("RColorBrewer")
library("WGCNA")
library("flashClust")
library("gridExtra")
library("ComplexHeatmap")
library("goseq")
library("dplyr")
library("clusterProfiler")
library("pheatmap")
library("magrittr")
library("reshape2")
```

# 1. Data preparation
## Load and format clean data
``` {r, echo=TRUE, warning=FALSE, message=FALSE}

data <- read.csv("../../output/Metabolomics/Norm_Data_All.csv", check.names = FALSE)

data$Grouping <- paste(data$Day, data$Group, sep= "_")

metadata <- data %>%
  select(Sample.ID, Grouping)

#removing metadata columns except the Sample ID
data2 <-data[-c(1, 3:5, 301)]

#melting dataset 
data3 <- melt(data2, id= "Sample.ID") 
names(data3)[2] <- 'Metabolite'
data3$value <- as.numeric(data3$value)

#Convert the data table to a wide format with samples in columns and metabolites in rows.  
data4 <- data3%>% 
  spread(Sample.ID, value)

#Turning metabolite names into rownames
head(data4) 
rownames(data4)<-data4$Metabolite 
data5 <-data4 %>%
  select(-Metabolite)


#Check that there are no metabolites with 0 counts for all samples. Should return TRUE.  
rowSums(dplyr::count(data5)) > 0
```

## Data filtering: PoverA and genefilter

Conduct data filtering, this includes:  

*pOverA*: Specifying the minimum count for a proportion of samples for each metabolite. Here, we are using a pOverA of 0.11. This is because we have 45 samples with a minimum of n=5 samples per group Therefore, we will accept genes that are present in 5/45 = 0.11 of the samples because we expect different metabolites by groups as demonstrated by PLSDA analysis. We are further setting the minimum value of metabolites to 1 (median normalized), such that 4% of the samples must have a non-zero normalized metabolite presence in order for the metabolite to remain in the data set.  

Filter in the package "genefilter". Pre-filtering our dataset to reduce the memory size dataframe, increase the speed of the transformation and testing functions, and improve quality of statistical analysis by removing low-coverage counts. Removed counts could represent outliers in the data and removing these improves sensitivity of statistical tests.   


``` {r, echo=TRUE, warning=FALSE, message=FALSE}

filt <- filterfun(pOverA(0.11,0.01))
#create filter for the counts data
gfilt <- genefilter(data5, filt)
#identify genes to keep by count filter
keep <- data5[gfilt,]
#identify genes to keep by count filter
keep <- data5[gfilt,]
#identify gene lists
n.keep <- rownames(keep)
#gene count data filtered in PoverA, P percent of the samples have counts over A
data_filt <- as.data.frame(data5[which(rownames(data5) %in% n.keep),])
#How many rows do we have before and after filtering?
nrow(data5) #Before
nrow(data_filt) #After

#Filtering removed 1 metabolite, 291 metabolites are used in analysis.  
```

##Outlier detection
``` {r, echo=TRUE, warning=FALSE, message=FALSE}
#Checking that all row and column names match. Should return "TRUE"
all(rownames(metadata$Sample.ID) %in% colnames(data_filt))
all(rownames(metadata$Sample.ID) == colnames(data_filt))

sampleTree = hclust(dist(data_filt), method = "average");
# Plot the sample tree: Open a graphic output window of size 12 by 9 inches
# The user should change the dimensions if the window is too large or too small.
pdf("../../output/Metabolomics/WGCNA/outliers_metabolites.pdf")
plot(sampleTree, main = "Sample clustering to detect outliers", sub="", xlab="", cex.lab = 1.5, cex.axis = 1.5, cex.main = 2)
dev.off()

#no metabolite outliers

#Transpose such that samples are in rows and metabolites are in columns.

tdata_filt <- t(data_filt) 

#Look for outliers by examining tree of samples  
sampleTree = hclust(dist(tdata_filt), method = "average");
# Plot the sample tree: Open a graphic output window of size 12 by 9 inches
# The user should change the dimensions if the window is too large or too small.
pdf("../../output/Metabolomics/WGCNA/outliers_samples.pdf")
plot(sampleTree, main = "Sample clustering to detect outliers", sub="", xlab="", cex.lab = 1.5, cex.axis = 1.5, cex.main = 2)
dev.off()

# Maybe Control_Ambient_day37_4? 
```

# 2. Network construction and consensus modlue detection
## Choosing a soft-thresholding power: Analysis of a network topology β
``` {r, echo=TRUE, warning=FALSE, message=FALSE}
# Choose a set of soft-thresholding powers
#powers <- c(seq(from = 1, to=200, by=2), c(21:30)) #Create a string of numbers from 1 through 10, and even numbers from 10 through 20

allowWGCNAThreads() 
powers <- c(c(1:20), seq(from = 12, to=20, by=2)) #Create a string of numbers from 1 through 10, and even numbers from 10 through 20

# Call the network topology analysis function
sft <-pickSoftThreshold(tdata_filt, powerVector = powers, verbose = 5)

#Plot the results.  
sizeGrWindow(9, 5)
par(mfrow = c(1,2));
cex1 = 0.9;
# # # Scale-free topology fit index as a function of the soft-thresholding power
plot(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
      xlab="Soft Threshold (power)",ylab="Scale Free Topology Model Fit,signed R^2",type="n",
     main = paste("Scale independence"));
 text(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
     labels=powers,cex=cex1,col="red");
# # # this line corresponds to using an R^2 cut-off
 abline(h=0.8,col="red")
# # # Mean connectivity as a function of the soft-thresholding power
 plot(sft$fitIndices[,1], sft$fitIndices[,5],
     xlab="Soft Threshold (power)",ylab="Mean Connectivity", type="n",
     main = paste("Mean connectivity"))
 text(sft$fitIndices[,1], sft$fitIndices[,5], labels=powers, cex=cex1,col="red")

 # Soft Threshold power is 12, 11 is close and reduced the number of modules to 4 instead of 5
```


## Departing from AH script here

https://bioinformaticsworkbook.org/tutorials/wgcna.html#gsc.tab=0


``` {r, echo=TRUE, warning=FALSE, message=FALSE}

picked_power = 12
temp_cor <- cor       
cor <- WGCNA::cor                                             # Force it to use WGCNA cor function (fix a namespace conflict issue)
netwk <- blockwiseModules(tdata_filt,                         # <= input here

                          # == Adjacency Function ==
                          power = picked_power,               # <= power here
                          networkType = "unsigned",

                          # == Tree and Block Options ==
                          deepSplit = 2,
                          pamRespectsDendro = F,
                          # detectCutHeight = 0.75,
                          minModuleSize = 5,                  #condsider inreasing or decreasing this
                          maxBlockSize = 4000,

                          # == Module Adjustments ==
                          reassignThreshold = 0,
                          mergeCutHeight = 0.25,

                          # == TOM == Archive the run results in TOM file (saves time)
                          saveTOMs = T,
                          saveTOMFileBase = "ER",

                          # == Output Options
                          numericLabels = T,
                          verbose = 3)

cor <- temp_cor     # Return cor function to original namespace

# Convert labels to colors for plotting
mergedColors = labels2colors(netwk$colors)
# Plot the dendrogram and the module colors underneath
plotDendroAndColors(
  netwk$dendrograms[[1]],
  mergedColors[netwk$blockGenes[[1]]],
  "Module colors",
  dendroLabels = FALSE,
  hang = 0.03,
  addGuide = TRUE,
  guideHang = 0.05 )

```


## Relate Module (cluster) Assignments to SampleID 

``` {r, echo=TRUE, warning=FALSE, message=FALSE}
module_df <- data.frame(
  Metabolite = names(netwk$colors),
  colors = labels2colors(netwk$colors)
)

module_df[1:5,]

write.csv(module_df, "../../output/Metabolomics/WGCNA/metabolite_modules.csv")

# Get Module Eigengenes per cluster
MEs <- moduleEigengenes(tdata_filt, mergedColors)$eigengenes

# Reorder modules so similar modules are next to each other
MEs <- orderMEs(MEs)
module_order = names(MEs) %>% gsub("ME","", .)

# Add Sample names
MEs0 <- MEs
MEs0$Sample.ID = row.names(MEs)

# tidy & plot data
mME = MEs0 %>%
  pivot_longer(-Sample.ID) %>%
  mutate(
    name = gsub("ME", "", name),
    name = factor(name, levels = module_order)
  )

mME %>% ggplot(., aes(x=Sample.ID, y=name, fill=value)) +
  geom_tile() +
  theme_bw() +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1,1)) +
  theme(axis.text.x = element_text(angle=90)) +
  labs(title = "Module-Sample Relationships", y = "Modules", fill="corr")
```


## Relate Module (cluster) Assignments to Groupings 

Prepare trait data. Data has to be numeric, so I will substitute time points/developmental stages for numeric values. The "trait" we are considering here is Grouping  

Make a dataframe that has a column for each lifestage name and a row for samples. Populate a 1 for samples that match each Group and a 0 for samples not matching respective Groups 

This process changes Groups from a categorical variable into a binary variable. This will allow for correlations between mean eigengenes and Groups  

``` {r, echo=TRUE, warning=FALSE, message=FALSE}

metadata$num <- c("1")
allTraits <- as.data.frame(pivot_wider(metadata, names_from = Grouping, values_from = num, id_cols = Sample.ID))
allTraits[is.na(allTraits)] <- c("0")
rownames(allTraits) <- allTraits$Sample.ID
datTraits <- allTraits[,c(-1)]
head(datTraits)

# Define numbers of genes and samples and print. 
nMetabolites = ncol(tdata_filt)
nSamples = nrow(tdata_filt)
nMetabolites #295
nSamples#45

# Correlations of traits with eigengenes
moduleTraitCor = cor(MEs, datTraits, use = "p");
moduleTraitPvalue = corPvalueStudent(moduleTraitCor, nSamples);
Colors=sub("ME","", names(MEs))
moduleTraitTree = hclust(dist(t(moduleTraitCor)), method = "average")
pdf(file="../../output/Metabolomics/WGCNA/ModuleTraitClusterTree.pdf", height=8, width=22)
plot(moduleTraitTree)
dev.off()

# Correlations of metabolites with eigengenes. Calculate correlations between ME's and groups 
moduleGeneCor=cor(MEs,tdata_filt)
moduleGenePvalue = corPvalueStudent(moduleGeneCor, nSamples);
head(moduleGenePvalue)

#Calculate kME values (module membership). 
#datKME = signedKME(tdata_filt, MEs0, outputColumnName = "kME")
#head(datKME)

#Save module colors and labels for use in subsequent analyses.  
#save(MEs, moduleLabels, moduleColors, geneTree, file = "Mcap2020/Output/Metabolomics/NetworkConstructionWGCNA.RData") 
```

## Plot module-trait associations

Represent module trait correlations as a heatmap 
```{r, echo=TRUE, warning=FALSE, message=FALSE}
textMatrix = paste(signif(moduleTraitCor, 2), "\n(",signif(moduleTraitPvalue, 1), ")", sep = "")
dim(textMatrix) = dim(moduleTraitCor)
head(textMatrix)
labeledHeatmap(Matrix = moduleTraitCor, xLabels = names(datTraits),  yLabels = names(MEs), ySymbols = names(MEs), cex.lab.y= 0.55, cex.lab.x= 0.55, colors = blueWhiteRed(50), textMatrix = textMatrix, setStdMargins = TRUE, cex.text = 0.25, textAdj = , zlim = c(-1,1), main = paste("Module-trait relationships"))
pdf(file="../../output/Metabolomics/WGCNA/Module-trait-relationships.pdf")
labeledHeatmap(Matrix = moduleTraitCor, xLabels = names(datTraits),  yLabels = names(MEs), ySymbols = names(MEs), cex.lab.y= 0.55, cex.lab.x= 0.55, colors = blueWhiteRed(50), textMatrix = textMatrix, setStdMargins = TRUE, cex.text = 0.25, textAdj = , zlim = c(-1,1), main = paste("Module-trait relationships"))
dev.off()

```

# Generate a complex heatmap of module-trait relationships.  

```{r, echo=TRUE, warning=FALSE, message=FALSE}
#bold sig p-values
#dendrogram with WGCNA MEtree cut-off
#colored y-axis
#Create list of pvalues for eigengene correlation with specific life stages
heatmappval <- signif(moduleTraitPvalue, 1)
#Make list of heatmap row colors
htmap.colors <- names(MEs)
htmap.colors <- gsub("ME", "", htmap.colors)
library(dendsort)
row_dend = dendsort(hclust(dist(moduleTraitCor)))
col_dend = dendsort(hclust(dist(t(moduleTraitCor))))


#row_ha = rowAnnotation(ModuleSize = anno_text("11", "127", "8", "64", "85"), just = "left", 
#        location = unit(0.5, "npc"), show_name = TRUE)
# brown (11), grey (127), yellow (8), blue (64), turqoise (85) #figure out how to do row annotations to add sample sizes

pdf(file = "../../output/Metabolomics/WGCNA/Module-trait-relationship-heatmap.pdf", height = 8, width = 8)
ht=Heatmap(moduleTraitCor, name = "Eigengene", column_title = "Module-Group Eigengene Correlation", 
        col = blueWhiteRed(50), 
        row_names_side = "left", 
        row_dend_side = "left",
        width = unit(5, "in"), 
        height = unit(4.5, "in"), 
        column_dend_reorder = TRUE, 
        #cluster_columns = hclust(dist(t(moduleTraitCor)), method = "average"),
        cluster_columns = col_dend,
        row_dend_reorder = FALSE,
        column_split = 6, 
        column_dend_height = unit(.5, "in"),
        #cluster_rows = METree, 
        cluster_rows = row_dend, 
        row_gap = unit(2.5, "mm"), 
        border = TRUE,
        cell_fun = function(j, i, x, y, w, h, col) {
        if(heatmappval[i, j] < 0.05) {
            grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
        }
        else {
            grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
        }},
        column_names_gp =  gpar(fontsize = 12, border=FALSE),
        row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE))
draw(ht)
dev.off()
```

# Plot mean eigengene values for each module

```{r, echo=TRUE, warning=FALSE, message=FALSE}

# Number of each metabolites in each module 
row_mod_num <- data.frame(table(module_df$colors)) 

# Bring in additional metadata

sample_metadata <- read.csv("../../data/Metabolomics/Porites-Kevin_SampleInfo2.csv") 
sample_metadata <- sample_metadata %>% select(Sample.ID, Day, Group)
sample_metadata$Day <- as.factor(sample_metadata$Day)

mME_meta <- merge(mME, sample_metadata, by = "Sample.ID") %>%
  rename(Module = name)

mME_meta$Module <- factor(mME_meta$Module, levels = c("brown", "grey", "yellow", "blue", "turquoise"))

module_order <- c("brown", "grey", "yellow", "blue", "turquoise")

mME_meta2 <- mME_meta %>% arrange(match(Module, module_order))

expression_plots<-mME_meta%>%
#  group_by(Module) %>%
  ggplot(aes(x=Day, y=value, fill=Group)) +
  facet_grid(Module ~.)+
  ylab("Mean Module Eigenegene Value") +
  geom_hline(yintercept = 0, linetype="dashed", color = "grey")+
  geom_boxplot(width=.5, outlier.shape= NA, position = position_dodge(width = 0.5), alpha = 0.7) +
  stat_summary(fun=mean, geom="line", aes(group=Group, color = Group), position = position_dodge(width = 0.5))  + 
  geom_point(pch = 21, position = position_dodge(width = 0.5)) +
  scale_fill_manual(values=c("#CC3300", "#46008B", "#468B00")) +
  scale_color_manual(values=c("#CC3300", "#46008B", "#468B00")) + 
  scale_x_discrete(labels=c("0" = "Day 0", "37" = "Day 37", "52" = "Day 52")) +
  xlab("Timepoint") + #Axis titles
  theme_bw() + theme(panel.border = element_rect(color="black", fill=NA, size=0.75), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_blank()) +
  theme(axis.text = element_text(size = 15, color = "black"),
        axis.title = element_text(size = 18, color = "black")); expression_plots

ggsave(filename="../../output/Metabolomics/WGCNA/expression_eigengene.jpeg", plot=expression_plots, dpi=300, width=7, height=10, units="in")

```


# Pathway Analysis for each module

```{r, echo=TRUE, warning=FALSE, message=FALSE}

module_df <- read.csv("../../output/Metabolomics/WGCNA/metabolite_modules.csv")

module_df <- module_df %>% rename(Module = colors)

# Select metabolites for each module 
#brown (n=11), yellow (n=8), blue (n=64), turquoise (n=85), grey (n=127), 

module_brown <- module_df %>% filter(Module == "brown")  %>% select(Metabolite)
module_yellow <- module_df %>% filter(Module == "yellow")  %>% select(Metabolite)
module_blue <- module_df %>% filter(Module == "blue")  %>% select(Metabolite)
module_turquoise <- module_df %>% filter(Module == "turquoise")  %>% select(Metabolite)
module_grey <- module_df %>% filter(Module == "grey")  %>% select(Metabolite)

library(MetaboAnalystR)

# Enrichment analysis for Brown module

mSet_brown <-InitDataObjects("conc", "msetora", FALSE)
cmpd.vec<-c(module_brown$Metabolite)
mSet_brown<-Setup.MapData(mSet_brown, cmpd.vec)
mSet_brown<-CrossReferencing(mSet_brown, "name")
mSet_brown<-CreateMappingResultTable(mSet_brown)
mSet_brown<-GetCandidateList(mSet_brown)
mSet_brown[["name.map"]][["hit.values"]]
mSet_brown<-SetMetabolomeFilter(mSet_brown, F)

mSet_brown_dataset <- mSet_brown$dataSet #extracting input dataframe
mSet_brown_KEGG <- as.data.frame(mSet_brown_dataset$map.table) #extracting KEGG terms
write.csv(mSet_brown_KEGG, "../../output/Metabolomics/MetaboAnalyst/mSet_brown_KEGG.csv")

mSet_brown<-SetCurrentMsetLib(mSet_brown, "kegg_pathway", 2)
mSet_brown<-CalculateHyperScore(mSet_brown)
mSet_brown_Path_KEGG <- mSet_brown$api
mSet_brown_ora <- as.data.frame(mSet_brown_Path_KEGG$ora.results)
write.csv(mSet_brown_ora, "../../output/Metabolomics/MetaboAnalyst/mSet_brown_ora.csv")

#Figure out how to print associated metabolites for each pathway. Ideally print a column in the mSet_brown_ora with a metabolites column
#mSet_brown[["analSet"]][["ora.hits"]][["Galactose metabolism"]]

# Enrichment analysis for Yellow module

mSet_yellow <-InitDataObjects("conc", "msetora", FALSE)
cmpd.vec.yellow<-c(module_yellow$Metabolite)
mSet_yellow<-Setup.MapData(mSet_yellow, cmpd.vec.yellow)
mSet_yellow<-CrossReferencing(mSet_yellow, "name")
mSet_yellow<-CreateMappingResultTable(mSet_yellow)
mSet_yellow<-GetCandidateList(mSet_yellow)
mSet_yellow[["name.map"]][["hit.values"]]
mSet_yellow<-SetMetabolomeFilter(mSet_yellow, F)

mSet_yellow_dataset <- mSet_yellow$dataSet #extracting input dataframe
mSet_yellow_KEGG <- as.data.frame(mSet_yellow_dataset$map.table) #extracting KEGG terms
write.csv(mSet_yellow_KEGG, "../../output/Metabolomics/MetaboAnalyst/mSet_yellow_KEGG.csv")

mSet_yellow<-SetCurrentMsetLib(mSet_yellow, "kegg_pathway", 2)
mSet_yellow<-CalculateHyperScore(mSet_yellow)
mSet_yellow_Path_KEGG <- mSet_yellow$api
mSet_yellow_ora <- as.data.frame(mSet_yellow_Path_KEGG$ora.results)
write.csv(mSet_yellow_ora, "../../output/Metabolomics/MetaboAnalyst/mSet_yellow_ora.csv")

# Enrichment analysis for blue module

mSet_blue <-InitDataObjects("conc", "msetora", FALSE)
cmpd.vec.blue<-c(module_blue$Metabolite)
mSet_blue<-Setup.MapData(mSet_blue, cmpd.vec.blue)
mSet_blue<-CrossReferencing(mSet_blue, "name")
mSet_blue<-CreateMappingResultTable(mSet_blue)
mSet_blue<-GetCandidateList(mSet_blue)

mSet_blue<-PerformDetailMatch(mSet_blue, "N-acetyl-L-ornithine")
mSet_blue<-SetCandidate(mSet_blue, "N-acetyl-L-ornithine", "N-Acetylornithine")

mSet_blue<-PerformDetailMatch(mSet_blue, "NG-dimethyl-L-arginine")
mSet_blue<-SetCandidate(mSet_blue, "NG-dimethyl-L-arginine", "Asymmetric dimethylarginine")

# mSet_blue<-PerformDetailMatch(mSet_blue, "Xanthosine-5-phosphate")
# mSet_blue<-GetCandidateList(mSet_blue)
# mSet_blue<-SetCandidate(mSet_blue, "Xanthosine-5-phosphate", "Xanthylic acid") #not working for some reason

mSet_blue[["name.map"]][["hit.values"]]
mSet_blue<-SetMetabolomeFilter(mSet_blue, F)

mSet_blue_dataset <- mSet_blue$dataSet #extracting input dataframe
mSet_blue_KEGG <- as.data.frame(mSet_blue_dataset$map.table) #extracting KEGG terms
write.csv(mSet_blue_KEGG, "../../output/Metabolomics/MetaboAnalyst/mSet_blue_KEGG.csv") #Invesrigate KEGG matching further

mSet_blue<-SetCurrentMsetLib(mSet_blue, "kegg_pathway", 2)
mSet_blue<-CalculateHyperScore(mSet_blue)
mSet_blue_Path_KEGG <- mSet_blue$api
mSet_blue_ora <- as.data.frame(mSet_blue_Path_KEGG$ora.results)
write.csv(mSet_blue_ora, "../../output/Metabolomics/MetaboAnalyst/mSet_blue_ora.csv")


# Enrichment analysis for turquoise module

mSet_turquoise <-InitDataObjects("conc", "msetora", FALSE)
cmpd.vec.turquoise<-c(module_turquoise$Metabolite)
mSet_turquoise<-Setup.MapData(mSet_turquoise, cmpd.vec.turquoise)
mSet_turquoise<-CrossReferencing(mSet_turquoise, "name")
mSet_turquoise<-CreateMappingResultTable(mSet_turquoise)

mSet_turquoise<-PerformDetailMatch(mSet_turquoise, "5- Methylthioadenosine")
mSet_turquoise<-GetCandidateList(mSet_turquoise)
mSet_turquoise<-SetCandidate(mSet_turquoise, "5- Methylthioadenosine", "5'-Methylthioadenosine")
mSet_turquoise<-PerformDetailMatch(mSet_turquoise, "Acetyl proline")
mSet_turquoise<-GetCandidateList(mSet_turquoise)
mSet_turquoise<-PerformDetailMatch(mSet_turquoise, "N-acetyl-glutamine")
mSet_turquoise<-GetCandidateList(mSet_turquoise)
mSet_turquoise<-SetCandidate(mSet_turquoise, "N-acetyl-glutamine", "N-Acetylglutamine")

mSet_turquoise<-GetCandidateList(mSet_turquoise)
mSet_turquoise[["name.map"]][["hit.values"]]
mSet_turquoise<-SetMetabolomeFilter(mSet_turquoise, F)

mSet_turquoise_dataset <- mSet_turquoise$dataSet #extracting input dataframe
mSet_turquoise_KEGG <- as.data.frame(mSet_turquoise_dataset$map.table) #extracting KEGG terms
write.csv(mSet_turquoise_KEGG, "../../output/Metabolomics/MetaboAnalyst/mSet_turquoise_KEGG.csv") #Invesrigate KEGG matching further

mSet_turquoise<-SetCurrentMsetLib(mSet_turquoise, "kegg_pathway", 2)
mSet_turquoise<-CalculateHyperScore(mSet_turquoise)
mSet_turquoise_Path_KEGG <- mSet_turquoise$api
mSet_turquoise_ora <- as.data.frame(mSet_turquoise_Path_KEGG$ora.results)
write.csv(mSet_turquoise_ora, "../../output/Metabolomics/MetaboAnalyst/mSet_turquoise_ora.csv")



# Enrichment analysis for grey module

mSet_grey <-InitDataObjects("conc", "msetora", FALSE)
cmpd.vec.grey<-c(module_grey$Metabolite)
mSet_grey<-Setup.MapData(mSet_grey, cmpd.vec.grey)
mSet_grey<-CrossReferencing(mSet_grey, "name")
mSet_grey<-CreateMappingResultTable(mSet_grey)

mSet_grey<-PerformDetailMatch(mSet_grey, "1 3-Dimethyluric acid")
mSet_grey<-GetCandidateList(mSet_grey)
mSet_grey<-SetCandidate(mSet_grey, "1 3-Dimethyluric acid", "1,3-Dimethyluric acid")
mSet_grey<-PerformDetailMatch(mSet_grey, "Acetyl glycine")
mSet_grey<-GetCandidateList(mSet_grey)
mSet_grey<-SetCandidate(mSet_grey, "Acetyl glycine", "Phenylacetylglycine")
mSet_grey<-PerformDetailMatch(mSet_grey, "Acetyl-arginine")
mSet_grey<-GetCandidateList(mSet_grey)
mSet_grey<-SetCandidate(mSet_grey, "Acetyl-arginine", "N-a-Acetyl-L-arginine")
mSet_grey<-PerformDetailMatch(mSet_grey, "Arginine-Alanine")
mSet_grey<-GetCandidateList(mSet_grey)
mSet_grey<-SetCandidate(mSet_grey, "Arginine-Alanine", "Arginyl-Alanine")
mSet_grey<-PerformDetailMatch(mSet_grey, "Arginine-Glutamine")
mSet_grey<-GetCandidateList(mSet_grey)
mSet_grey<-SetCandidate(mSet_grey, "Arginine-Glutamine", "Arginyl-Glutamine")
mSet_grey<-PerformDetailMatch(mSet_grey, "Arginine-Valine")
mSet_grey<-GetCandidateList(mSet_grey)
mSet_grey<-SetCandidate(mSet_grey, "Arginine-Valine", "Arginyl-Valine")
mSet_grey<-PerformDetailMatch(mSet_grey, "Dihydroxybenzeneacetic acid")
mSet_grey<-GetCandidateList(mSet_grey)
mSet_grey<-SetCandidate(mSet_grey, "Dihydroxybenzeneacetic acid", "3,4-Dihydroxybenzeneacetic acid")
# mSet_grey<-PerformDetailMatch(mSet_grey, "gamma-amino butyrate")
# mSet_grey<-GetCandidateList(mSet_grey)
# mSet_grey<-SetCandidate(mSet_grey, "gamma-amino butyrate", "Gamma-Aminobutyric acid")
mSet_grey<-PerformDetailMatch(mSet_grey, "Glutaryl-carnitine")
mSet_grey<-GetCandidateList(mSet_grey)
mSet_grey<-PerformDetailMatch(mSet_grey, "Hydroxyphenyl pyruvate")
mSet_grey<-GetCandidateList(mSet_grey)
mSet_grey<-SetCandidate(mSet_grey, "Hydroxyphenyl pyruvate", "3-(3,4-Dihydroxyphenyl)pyruvate")
mSet_grey<-PerformDetailMatch(mSet_grey, "Lysine-Glutamine")
mSet_grey<-GetCandidateList(mSet_grey)
mSet_grey<-SetCandidate(mSet_grey, "Lysine-Glutamine", "Lysyl-Glutamine")
mSet_grey<-PerformDetailMatch(mSet_grey, "Methyloxovaleric acid (Ketoleucine)")
mSet_grey<-GetCandidateList(mSet_grey)
mSet_grey<-PerformDetailMatch(mSet_grey, "Methylphenyllactate")
mSet_grey<-GetCandidateList(mSet_grey)
mSet_grey<-SetCandidate(mSet_grey, "Methylphenyllactate", "3-Methylphenylacetic acid")
mSet_grey<-PerformDetailMatch(mSet_grey, "N N N-Trimethyllysine")
mSet_grey<-GetCandidateList(mSet_grey)
mSet_grey<-SetCandidate(mSet_grey, "N N N-Trimethyllysine", "N6,N6,N6-Trimethyl-L-lysine")
# mSet_grey<-PerformDetailMatch(mSet_grey, "Pyrroline-5-carboxylic acid")
# mSet_grey<-GetCandidateList(mSet_grey)
# mSet_grey<-SetCandidate(mSet_grey, "Pyrroline-5-carboxylic acid", "1-Pyrroline-5-carboxylic acid")
mSet_grey<-PerformDetailMatch(mSet_grey, "Ribose phosphate")
mSet_grey<-GetCandidateList(mSet_grey)
mSet_grey<-SetCandidate(mSet_grey, "Ribose phosphate", "Ribose 1-phosphate")

mSet_grey<-GetCandidateList(mSet_grey)
mSet_grey[["name.map"]][["hit.values"]]
mSet_grey<-SetMetabolomeFilter(mSet_grey, F)

mSet_grey_dataset <- mSet_grey$dataSet #extracting input dataframe
mSet_grey_KEGG <- as.data.frame(mSet_grey_dataset$map.table) #extracting KEGG terms
write.csv(mSet_grey_KEGG, "../../output/Metabolomics/MetaboAnalyst/mSet_grey_KEGG.csv") #Invesrigate KEGG matching further

mSet_grey<-SetCurrentMsetLib(mSet_grey, "kegg_pathway", 2)
mSet_grey<-CalculateHyperScore(mSet_grey)
mSet_grey_Path_KEGG <- mSet_grey$api
mSet_grey_ora <- as.data.frame(mSet_grey_Path_KEGG$ora.results)
write.csv(mSet_grey_ora, "../../output/Metabolomics/MetaboAnalyst/mSet_grey_ora.csv")

```

# Formatting data for network construction - come back to this
```{r, echo=TRUE, warning=FALSE, message=FALSE}
# Selecting module of interest 
# module_of_interest = "turquoise"
# 
# # Selecting metabolites from module of interest
# metabolites_of_interest = module_df %>%
#   subset(colors %in% module_of_interest )
# 
# expr_of_interest = data_filt[metabolites_of_interest$Metabolite,]
# 
# # Only recalculate TOM for modules of interest (faster, altho there's some online discussion if this will be slightly off)
# TOM = TOMsimilarityFromExpr(t(expr_of_interest),
#                             power = picked_power)
# 
# # Add gene names to row and columns
# row.names(TOM) = row.names(expr_of_interest)
# colnames(TOM) = row.names(expr_of_interest)
# 
# edge_list = data.frame(TOM, check.names = FALSE) %>%
#   mutate(
#     metab1 = row.names(.)
#   ) %>%
#   pivot_longer(-metab1) %>%
#   dplyr::rename(metab2 = name, correlation = value) %>%
#   unique() %>%
#   subset(!(metab1==metab2)) %>%
#   mutate(
#     module1 = module_of_interest,
#     module2 = module_of_interest
#   )
# 
# write_delim(edge_list,
#             file = "edgelist.tsv",
#             delim = "\t")
```





















